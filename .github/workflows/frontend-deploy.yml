name: ðŸŽ¨ Frontend Deployment

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - staging
          - production
      skip_tests:
        description: 'Skip tests and deploy directly'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  APP_NAME: 'fabric-embedded-app'

jobs:
  # ðŸ§ª Build and Test
  build-and-test:
    name: ðŸ—ï¸ Build & Test Frontend
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    
    defaults:
      run:
        working-directory: ./frontend
    
    outputs:
      build-version: ${{ steps.version.outputs.version }}
      build-hash: ${{ steps.hash.outputs.hash }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for versioning
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'
          
      - name: ðŸ“‹ Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
          npm list --depth=0
          
      - name: ðŸ” Code Quality Checks
        run: |
          # Lint
          npm run lint
          
          # Type checking
          npm run type-check
          
          # Format check
          npm run format:check
          
      - name: ðŸ§ª Run Unit Tests
        run: |
          npm run test:unit -- --coverage --watchAll=false
          
      - name: ðŸŒ Run Component Tests
        run: |
          npm run test:components -- --coverage --watchAll=false
          
      - name: ðŸ“Š Upload Test Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
          
      - name: ðŸ—ï¸ Build Application
        run: |
          echo "Building for environment: ${{ inputs.environment || 'production' }}"
          
          # Set environment variables for build
          export VITE_ENVIRONMENT="${{ inputs.environment || 'production' }}"
          export VITE_BUILD_DATE="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          export VITE_BUILD_COMMIT="${{ github.sha }}"
          export VITE_BUILD_VERSION="${{ github.run_number }}"
          
          npm run build
          
          # Verify build output
          ls -la dist/
          
      - name: ðŸ“ Bundle Analysis
        run: |
          # Analyze bundle size
          npm run analyze
          
          # Check for large files
          find dist -size +1M -type f -exec ls -lh {} \; | awk '{ print $9 ": " $5 }'
          
      - name: ðŸ”’ Security Scan
        run: |
          # Audit dependencies
          npm audit --audit-level=moderate
          
          # Check for outdated packages
          npm outdated || true
          
      - name: ðŸ“¦ Create Build Info
        id: version
        run: |
          version="1.0.${{ github.run_number }}"
          echo "version=$version" >> $GITHUB_OUTPUT
          
          # Create build info file
          cat > dist/build-info.json << EOF
          {
            "version": "$version",
            "buildDate": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "environment": "${{ inputs.environment || 'production' }}",
            "buildNumber": "${{ github.run_number }}",
            "workflow": "${{ github.workflow }}"
          }
          EOF
          
      - name: ðŸ” Generate Build Hash
        id: hash
        run: |
          build_hash=$(find dist -type f -exec sha256sum {} \; | sort | sha256sum | cut -d' ' -f1)
          echo "hash=$build_hash" >> $GITHUB_OUTPUT
          echo "Build hash: $build_hash"
          
      - name: ðŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ steps.version.outputs.version }}
          path: |
            ./frontend/dist/
            ./frontend/package.json
          retention-days: 30
          
      - name: ðŸ“Š Upload Bundle Stats
        uses: actions/upload-artifact@v4
        with:
          name: bundle-stats-${{ steps.version.outputs.version }}
          path: ./frontend/dist/stats.json
          retention-days: 7

  # ðŸš€ Deploy to Development
  deploy-development:
    name: ðŸ§ª Deploy to Development
    runs-on: ubuntu-latest
    if: |
      (github.ref == 'refs/heads/main' && !inputs.skip_tests) || 
      (inputs.environment == 'development')
    needs: [build-and-test]
    environment:
      name: development
      url: https://${{ env.APP_NAME }}-frontend-dev.azurewebsites.net
    
    steps:
      - name: ðŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ needs.build-and-test.outputs.build-version }}
          path: ./build/
          
      - name: ðŸ”‘ Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}
          
      - name: ðŸš€ Deploy to Development App Service
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.APP_NAME }}-frontend-dev
          package: ./build/dist
          
      - name: ðŸ”§ Configure Development Settings
        run: |
          az webapp config appsettings set \
            --name ${{ env.APP_NAME }}-frontend-dev \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP_DEV }} \
            --settings \
              ENVIRONMENT="development" \
              DEBUG_MODE="true" \
              VITE_ENTRA_CLIENT_ID="${{ secrets.VITE_ENTRA_CLIENT_ID_DEV }}" \
              VITE_API_BASE_URL="${{ secrets.VITE_API_BASE_URL_DEV }}" \
              BUILD_VERSION="${{ needs.build-and-test.outputs.build-version }}"
              
      - name: ðŸ¥ Health Check
        run: |
          sleep 30
          health_check_url="https://${{ env.APP_NAME }}-frontend-dev.azurewebsites.net/health"
          
          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "$health_check_url" || echo "000")
            if [ "$response" = "200" ]; then
              echo "âœ… Development deployment health check passed"
              break
            elif [ $i -eq 5 ]; then
              echo "âŒ Development deployment health check failed after 5 attempts"
              exit 1
            else
              echo "â³ Attempt $i failed, retrying in 30 seconds..."
              sleep 30
            fi
          done

  # ðŸš€ Deploy to Staging
  deploy-staging:
    name: ðŸŽ­ Deploy to Staging
    runs-on: ubuntu-latest
    if: |
      (github.ref == 'refs/heads/main' && !inputs.skip_tests) || 
      (inputs.environment == 'staging')
    needs: [build-and-test, deploy-development]
    environment:
      name: staging
      url: https://${{ env.APP_NAME }}-frontend-staging.azurewebsites.net
    
    steps:
      - name: ðŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ needs.build-and-test.outputs.build-version }}
          path: ./build/
          
      - name: ðŸ”‘ Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_STAGING }}
          
      - name: ðŸš€ Deploy to Staging Slot
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.APP_NAME }}-frontend
          slot-name: staging
          package: ./build/dist
          
      - name: ðŸ”§ Configure Staging Settings
        run: |
          az webapp config appsettings set \
            --name ${{ env.APP_NAME }}-frontend \
            --slot staging \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --settings \
              ENVIRONMENT="staging" \
              VITE_ENTRA_CLIENT_ID="${{ secrets.VITE_ENTRA_CLIENT_ID_STAGING }}" \
              VITE_API_BASE_URL="${{ secrets.VITE_API_BASE_URL_STAGING }}" \
              BUILD_VERSION="${{ needs.build-and-test.outputs.build-version }}"
              
      - name: ðŸ§ª Run Staging Tests
        run: |
          echo "Running staging-specific tests..."
          # Add staging tests here
          
      - name: ðŸ¥ Staging Health Check
        run: |
          sleep 30
          health_check_url="https://${{ env.APP_NAME }}-frontend-staging.azurewebsites.net/health"
          
          response=$(curl -s -o /dev/null -w "%{http_code}" "$health_check_url" || echo "000")
          if [ "$response" = "200" ]; then
            echo "âœ… Staging deployment health check passed"
          else
            echo "âŒ Staging deployment health check failed (HTTP $response)"
            exit 1
          fi

  # ðŸš€ Deploy to Production
  deploy-production:
    name: ðŸŒ Deploy to Production
    runs-on: ubuntu-latest
    if: |
      (github.ref == 'refs/heads/main' && !inputs.skip_tests) || 
      (inputs.environment == 'production')
    needs: [build-and-test, deploy-staging]
    environment:
      name: production
      url: https://${{ env.APP_NAME }}-frontend.azurewebsites.net
    
    steps:
      - name: ðŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ needs.build-and-test.outputs.build-version }}
          path: ./build/
          
      - name: ðŸ”‘ Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: ðŸ“Š Pre-deployment Backup
        run: |
          echo "Creating backup of current production deployment..."
          # Add backup logic here if needed
          
      - name: ðŸš€ Deploy to Production
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.APP_NAME }}-frontend
          package: ./build/dist
          
      - name: ðŸ”§ Configure Production Settings
        run: |
          az webapp config appsettings set \
            --name ${{ env.APP_NAME }}-frontend \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --settings \
              ENVIRONMENT="production" \
              VITE_ENTRA_CLIENT_ID="${{ secrets.VITE_ENTRA_CLIENT_ID }}" \
              VITE_ENTRA_TENANT_ID="${{ secrets.VITE_ENTRA_TENANT_ID }}" \
              VITE_API_BASE_URL="${{ secrets.VITE_API_BASE_URL }}" \
              VITE_POWERBI_WORKSPACE_ID="${{ secrets.VITE_POWERBI_WORKSPACE_ID }}" \
              BUILD_VERSION="${{ needs.build-and-test.outputs.build-version }}" \
              BUILD_HASH="${{ needs.build-and-test.outputs.build-hash }}"
              
      - name: ðŸŽ¯ Warm Up Application
        run: |
          echo "Warming up production application..."
          production_url="https://${{ env.APP_NAME }}-frontend.azurewebsites.net"
          
          # Warm up main routes
          curl -s "$production_url/" > /dev/null || true
          curl -s "$production_url/dashboard" > /dev/null || true
          curl -s "$production_url/reports" > /dev/null || true
          
          sleep 30
          
      - name: ðŸ¥ Production Health Check
        run: |
          production_url="https://${{ env.APP_NAME }}-frontend.azurewebsites.net"
          health_check_url="$production_url/health"
          
          for i in {1..10}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "$health_check_url" || echo "000")
            if [ "$response" = "200" ]; then
              echo "âœ… Production deployment health check passed"
              break
            elif [ $i -eq 10 ]; then
              echo "âŒ Production deployment health check failed after 10 attempts"
              
              # Get detailed error info
              echo "Detailed response:"
              curl -v "$health_check_url" || true
              
              exit 1
            else
              echo "â³ Attempt $i failed (HTTP $response), retrying in 30 seconds..."
              sleep 30
            fi
          done
          
      - name: ðŸ§ª Production Smoke Tests
        run: |
          echo "Running production smoke tests..."
          production_url="https://${{ env.APP_NAME }}-frontend.azurewebsites.net"
          
          # Test main application endpoints
          echo "Testing main page..."
          main_response=$(curl -s -o /dev/null -w "%{http_code}" "$production_url/")
          
          echo "Testing build info..."
          build_response=$(curl -s -o /dev/null -w "%{http_code}" "$production_url/build-info.json")
          
          if [ "$main_response" = "200" ] && [ "$build_response" = "200" ]; then
            echo "âœ… Production smoke tests passed"
          else
            echo "âŒ Production smoke tests failed (Main: $main_response, Build: $build_response)"
            exit 1
          fi

  # ðŸ“Š Post-deployment Tasks
  post-deployment:
    name: ðŸ“Š Post-deployment Tasks
    runs-on: ubuntu-latest
    if: success()
    needs: [build-and-test, deploy-production]
    
    steps:
      - name: ðŸ“ˆ Update Monitoring
        run: |
          echo "Updating monitoring dashboards..."
          echo "Deployment version: ${{ needs.build-and-test.outputs.build-version }}"
          echo "Build hash: ${{ needs.build-and-test.outputs.build-hash }}"
          
      - name: ðŸ“Š Performance Check
        run: |
          echo "Running performance checks..."
          production_url="https://${{ env.APP_NAME }}-frontend.azurewebsites.net"
          
          # Simple performance check
          start_time=$(date +%s%3N)
          curl -s "$production_url/" > /dev/null
          end_time=$(date +%s%3N)
          
          response_time=$((end_time - start_time))
          echo "Response time: ${response_time}ms"
          
          if [ $response_time -lt 3000 ]; then
            echo "âœ… Performance check passed"
          else
            echo "âš ï¸ Performance check warning: Response time is ${response_time}ms"
          fi
          
      - name: ðŸ”” Send Success Notification
        run: |
          echo "ðŸŽ‰ Frontend deployment completed successfully!"
          echo "Version: ${{ needs.build-and-test.outputs.build-version }}"
          echo "Environment: ${{ inputs.environment || 'production' }}"
          echo "URL: https://${{ env.APP_NAME }}-frontend.azurewebsites.net"
          
      - name: ðŸ“ Create Deployment Record
        run: |
          cat > deployment-record.json << EOF
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "version": "${{ needs.build-and-test.outputs.build-version }}",
            "buildHash": "${{ needs.build-and-test.outputs.build-hash }}",
            "environment": "${{ inputs.environment || 'production' }}",
            "commit": "${{ github.sha }}",
            "actor": "${{ github.actor }}",
            "workflow": "${{ github.workflow }}",
            "runId": "${{ github.run_id }}"
          }
          EOF
          
          echo "Deployment record created:"
          cat deployment-record.json

  # ðŸš¨ Rollback (Manual Trigger)
  rollback:
    name: ðŸ”„ Rollback Deployment
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'workflow_dispatch'
    needs: [deploy-production]
    environment:
      name: production-rollback
    
    steps:
      - name: ðŸ”‘ Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: ðŸ”„ Perform Rollback
        run: |
          echo "ðŸš¨ Performing emergency rollback..."
          
          # Swap back to previous slot if using slots
          # Or redeploy previous version
          
          echo "âš ï¸ Manual rollback procedure:"
          echo "1. Go to Azure Portal"
          echo "2. Navigate to App Service: ${{ env.APP_NAME }}-frontend"
          echo "3. Use Deployment slots to swap back"
          echo "4. Or redeploy previous version from deployment history"
          
      - name: ðŸ“¢ Rollback Notification
        run: |
          echo "ðŸš¨ ROLLBACK INITIATED"
          echo "Frontend deployment has been rolled back"
          echo "Please check the application and investigate the issue"